# Attention Guided Low light Image Enhancement

## Project Name
Attention Guided Low light Image Enhancement

## Objective

Given an image captured in insufficient and low light , produce an enhanced and brighter version.
## What's the need for creating this Model?
The traditional methods use Histogram Equalization techniques which is not very effective. Another type of models that are based on the Retinex theory introduce significant noise in the produced image. This is primiarily because low light regions need special attention which is not given in those methods. In this implementation of the model described in [1] , special attention is given to lowest brightness images and a combined loss function is used as described later. The results thus inferred are quiet good.


## Results

![Low light Image](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download.png)
![Original Image in bright light](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(1).png)
![Image generated by Model](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(2).png)                                  
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Low light Image** &nbsp; &nbsp;  &nbsp;  &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; **Original Image in bright light**&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Image generated by Model**

![Low light Image](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(3).png)
![Original Image in bright light](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(4).png)
![Image generated by Model](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(5).png)                                  
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Low light Image** &nbsp; &nbsp;  &nbsp;  &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; **Original Image in bright light**&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Image generated by Model**

![Low light Image](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(6).png)
![Original Image in bright light](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(7).png)
![Image generated by Model](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(8).png)                                  
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Low light Image** &nbsp; &nbsp;  &nbsp;  &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; **Original Image in bright light**&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Image generated by Model**

![Low light Image](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(9).png)
![Original Image in bright light](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(10).png)
![Image generated by Model](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/Results/download%20(11).png)                                  
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Low light Image** &nbsp; &nbsp;  &nbsp;  &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; **Original Image in bright light**&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **Image generated by Model**

## Model Performance
**Mean PSNR**  -  30.41332\
**Mean SSIM**  -   0.60365\
**Mean MAE**   -  25.25668

## Brief Discussion 

### The Model
The model implemented is in multi-branch fashion. The input is a low light image and the output is an enhanced and clean imaeg of the same dimension.
The model architecture is as shown below.

![Model Architecture](https://github.com/amcs1729/Attention-Guided-Low-light-Image-Enhancement/blob/master/Images/model_structure.png)

### The Loss function
What makes this model much better is a combined loss function. It combines-
* Context Loss - The output image produced by the model and the original bright image are fed into a VGG model with the last fully connected layer removed and the output of 'block3_conv4' is taken and then their MAE is taken
* Structure Loss - The SSIM and MS-SSIM is calculated between the original bright image and the image produced by the model. Structure Loss = 6 - (SSIM + MS-SSIM)
* Region Loss - Since the darker parts of the origin low light image need more attention , this loss calculates the MAE between the output and true bright image and gives 4 times more weight on 40% of the darkest pixels.


The final loss is calculated as a combination of Context Loss , Region Loss and Structure Loss

## Implementation Details

Dataset - LOL Dataset is used fro this project. It contains (485\*2) images, 485 low lighth images and their corresponding bright images for training.The testing was done with 15 images, the outputs of some of which are attached above. \
 \
Hardware - I used the Kaggle Platform for training which provides 16 GB Nvidia Titan X GPU and 13 GB of RAM. \
 \
Training - The images were resized to (256,256,3) shape for using as input to the model.The training was done using Batch Size of 32 and a initial learning rate of 0.001 using Adam optimizer. The learning rate was reduced when plateau is reached using keras callbacks. The model was trained for 232 epochs, after which the model stopped improving.

## References
<a id="1">[1]</a> 
MBLLEN: Low-light Image/Video Enhancement Using CNNs by
 Feifan Lv, Feng Lu, Jianhua Wu, Chongsoon Lim,
 booktitle - British Machine Vision Conference (BMVC),
 year={2018}
 (http://bmvc2018.org/contents/papers/0700.pdf)
 
 <a id="2">[2]</a>
 Chen2018Retinex,
 Deep Retinex Decomposition for Low-Light Enhancement by 
 Chen Wei, Wenjing Wang, Wenhan Yang, Jiaying Liu,
 booktitle - British Machine Vision Conference,
 year={2018},
 organization - British Machine Vision Association
(https://drive.google.com/open?id=157bjO1_cFuSd0HWDUuAmcHRJDVyWpOxB)
